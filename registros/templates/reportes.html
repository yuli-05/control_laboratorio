{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">📊 Reporte de uso de laboratorios</h2>

    <!-- FILTROS -->
    <form method="GET" class="card p-3 mb-4 shadow-sm" id="filtros-form">
        <div class="row g-3">
        <div class="col-md-3">
            <label for="fecha_inicio" class="form-label">Fecha inicio</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control"
                value="{{ request.GET.fecha_inicio }}">
        </div>
        <div class="col-md-3">
            <label for="fecha_fin" class="form-label">Fecha fin</label>
            <input type="date" id="fecha_fin" name="fecha_fin" class="form-control"
                value="{{ request.GET.fecha_fin }}">
        </div>
        <div class="col-md-3">
            <label for="laboratorio" class="form-label">Laboratorio</label>
            <select id="laboratorio" name="laboratorio" class="form-select">
            <option value="">-- Todos --</option>
            {% for codigo, nombre in laboratorios_choices %}
                <option value="{{ codigo }}"
                {% if laboratorio_seleccionado == codigo %}selected{% endif %}>
                {{ nombre }}
                </option>
            {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="docente" class="form-label">Docente</label>
            <select id="docente" name="docente" class="form-select">
            <option value="">Todos</option>
            {% for d in docentes %}
                <option value="{{ d.id }}"
                {% if docente_seleccionado == d.id %}selected{% endif %}>
                {{ d.nombre }}
                </option>
            {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="carrera" class="form-label">Carrera</label>
            <select id="carrera" name="carrera" class="form-select">
            <option value="">Todas</option>
            {% for c in carreras %}
                <option value="{{ c }}"
                {% if carrera_seleccionada == c %}selected{% endif %}>
                {{ c }}
                </option>
            {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="materia" class="form-label">Materia</label>
            <select id="materia" name="materia" class="form-select">
            <option value="">Todas</option>
            {% for m in materias %}
                <option value="{{ m }}"
                {% if materia_seleccionada == m %}selected{% endif %}>
                {{ m }}
                </option>
            {% endfor %}
            </select>
        </div>
        </div>
        <div class="mt-3 text-end">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-funnel-fill me-1"></i> Filtrar
        </button>
        </div>
    </form>

    <!-- BOTONES DE EXPORTACIÓN -->
    <div class="mb-4 d-flex gap-2">
        <button id="exportar-excel" class="btn btn-success">
        <i class="bi bi-file-earmark-excel-fill me-1"></i> Exportar a Excel
        </button>
        <button id="exportar-pdf" class="btn btn-danger">
        <i class="bi bi-file-earmark-pdf-fill me-1"></i> Exportar a PDF
        </button>
    </div>

    <!-- ESTADÍSTICAS POR LABORATORIO -->
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
        {% for est in estadisticas_laboratorios %}
        <div class="card shadow-sm">
            <div class="card-body">
            <h5 class="card-title">{{ est.laboratorio }}</h5>
            <p class="mb-1"><strong>Registros:</strong> {{ est.registros }}</p>
            <p class="mb-1"><strong>Horas programadas:</strong> {{ est.horas_programadas }}</p>
            <p class="mb-1"><strong>Horas cumplidas:</strong> {{ est.horas_cumplidas }}</p>
            <p class="mb-2"><strong>% Cumplimiento:</strong> {{ est.porcentaje|floatformat:1 }}%</p>
            <div class="progress mb-3">
                <div class="progress-bar bg-success"
                    role="progressbar"
                    style="width: {{ est.porcentaje }}%;"
                    aria-valuenow="{{ est.porcentaje }}"
                    aria-valuemin="0"
                    aria-valuemax="100">
                </div>
            </div>
            <button class="btn btn-outline-primary ver-registros-btn"
                    data-lab-id="{{ est.codigo }}">
                Ver registros
            </button>

            <button class="btn btn-outline-secondary ver-docentes-btn ms-2"
                    data-lab-id="{{ est.codigo }}">
                Ver por docente
            </button>


            </div>
        </div>
        {% endfor %}
    </div>

    <<!-- Tabla general por laboratorio -->
    <div id="tabla-registros-laboratorio" class="mt-4"></div>

    <!-- Tabla por docente -->
    <div id="tabla-docentes-laboratorio" class="mt-4"></div>

    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
          // función auxiliar para leer filtros
          function getQueryParams() {
            const params = new URLSearchParams();
            ['fecha_inicio','fecha_fin','docente','carrera','materia'].forEach(name => {
              const el = document.querySelector(`[name="${name}"]`);
              if (el && el.value) params.append(name, el.value);
            });
            return params.toString();
          }
        
          // -------- Ver registros por laboratorio --------
          document.querySelectorAll(".ver-registros-btn").forEach(btn => {
            btn.addEventListener("click", function () {
              const labId = this.dataset.labId;
              const qs    = getQueryParams();
              fetch(`/registros_por_laboratorio/${labId}/?${qs}`)
                .then(resp => resp.ok ? resp.text() : Promise.reject(resp.statusText))
                .then(html => {
                  document.getElementById("tabla-registros-laboratorio").innerHTML = html;
                  window.scrollTo({
                    top: document.getElementById("tabla-registros-laboratorio").offsetTop - 80,
                    behavior: 'smooth'
                  });
                })
                .catch(err => console.error("Error al cargar registros:", err));
            });
          });
        
          // -------- Ver tabla de docentes por laboratorio --------
          document.querySelectorAll(".ver-docentes-btn").forEach(btn => {
            btn.addEventListener("click", function () {
              const labId = this.dataset.labId;
              const qs    = getQueryParams();
              fetch(`/registros_por_laboratorio/${labId}/docentes/?${qs}`)
                .then(resp => resp.ok ? resp.text() : Promise.reject(resp.statusText))
                .then(html => {
                  document.getElementById("tabla-docentes-laboratorio").innerHTML = html;
                  window.scrollTo({
                    top: document.getElementById("tabla-docentes-laboratorio").offsetTop - 80,
                    behavior: 'smooth'
                  });
                })
                .catch(err => console.error("Error al cargar tabla de docentes:", err));
            });
          });
        });
        </script>
        
        
            
{% endblock %}
